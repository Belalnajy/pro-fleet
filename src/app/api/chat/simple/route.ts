import { NextRequest, NextResponse } from "next/server"

// Simple chatbot responses without database
const chatbotResponses = {
  // Greetings
  greetings: {
    patterns: ["hello", "hi", "hey", "ูุฑุญุจุง", "ูุฑุญุจุงู", "ุฃููุง", "ุฃููุงู", "ุงูุณูุงู ุนูููู"],
    responses: [
      "ูุฑุญุจุงู! ุฃูุง ูุณุงุนุฏ PRO FLEET ุงูุฐูู ๐ค\nููู ูููููู ูุณุงุนุฏุชู ุงููููุ",
      "ุฃููุงู ูุณููุงู! ๐\nุฃูุง ููุง ููุณุงุนุฏุชู ูู ุฌููุน ุฎุฏูุงุช ุงูููู ูุงูุดุญู",
      "ูุฑุญุจุงู ุจู ูู PRO FLEET! ๐\nููู ูููููู ุฎุฏูุชูุ"
    ]
  },
  
  // Trip tracking
  tracking: {
    patterns: ["track", "ุชุชุจุน", "tracking", "ูููุน", "location", "ุฃูู", "where", "pro-"],
    responses: [
      "๐ ูุชุชุจุน ุดุญูุชู:\nโข ุฃุฏุฎู ุฑูู ุงูุฑุญูุฉ (ูุซู: PRO-20241224-001)\nโข ุฃู ุงุฐูุจ ูุตูุญุฉ 'ุชุชุจุน ุงูุดุญูุงุช'\nโข ุฃู ูู ูู ุฑูู ุงูุฑุญูุฉ ูุจุงุดุฑุฉ"
    ]
  },
  
  // Trip management
  trips: {
    patterns: ["trip", "ุฑุญูุฉ", "ุฑุญูุงุช", "ุดุญูุฉ", "ุดุญูุงุช", "ุญุฌุฒ", "book"],
    responses: [
      "๐ ุฎุฏูุงุช ุงูุฑุญูุงุช:\nโข ุญุฌุฒ ุฑุญูุฉ ุฌุฏูุฏุฉ\nโข ุชุชุจุน ุงูุฑุญูุงุช ุงูุญุงููุฉ\nโข ุชุงุฑูุฎ ุงูุฑุญูุงุช\nโข ุฅูุบุงุก ุฃู ุชุนุฏูู ุงูุฑุญูุฉ\n\nูุงุฐุง ุชุฑูุฏ ุฃู ุชูุนูุ"
    ]
  },
  
  // Pricing
  pricing: {
    patterns: ["price", "ุณุนุฑ", "ุฃุณุนุงุฑ", "ุชูููุฉ", "cost", "pricing", "ูู", "how much"],
    responses: [
      "๐ฐ ุฃุณุนุงุฑูุง ุชุนุชูุฏ ุนูู:\nโข ุงููุณุงูุฉ ูุงููุณุงุฑ\nโข ููุน ุงููุฑูุจุฉ ุงููุทููุจุฉ\nโข ุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ (ุนุงุฏู/ูุจุฑุฏ/ูุฌูุฏ)\nโข ุงููุฒู ูุงูุญุฌู\nโข ุงูุฎุฏูุงุช ุงูุฅุถุงููุฉ\n\nููููู ุงูุญุตูู ุนูู ุนุฑุถ ุณุนุฑ ููุฑู ูู ุตูุญุฉ 'ุญุฌุฒ ุฑุญูุฉ'"
    ]
  },
  
  // Company info
  company: {
    patterns: ["company", "ุดุฑูุฉ", "ูุนูููุงุช", "info", "about", "ุนู", "ูู ูุญู"],
    responses: [
      "๐ข PRO FLEET - ุดุฑูุฉ ุฑุงุฆุฏุฉ ูู ุงูููู ูุงูุดุญู:\nโข ุฎุจุฑุฉ ูุงุณุนุฉ ูู ุงูููู ุงูุจุฑู\nโข ุฃุณุทูู ุญุฏูุซ ููุชููุน\nโข ุชุชุจุน ูุจุงุดุฑ ูููุฑู\nโข ุฎุฏูุฉ ุนููุงุก 24/7\nโข ุชุบุทูุฉ ุดุงููุฉ ููููููุฉ\n\n๐ ููุชูุงุตู: +966 53 997 7837\n๐ง ุงูุจุฑูุฏ: info@profleet.app"
    ]
  },
  
  // Services
  services: {
    patterns: ["services", "ุฎุฏูุงุช", "service", "ุฎุฏูุฉ", "ูุงุฐุง ุชูุฏููู", "what do you offer"],
    responses: [
      "๐๏ธ ุฎุฏูุงุชูุง ุงูุดุงููุฉ:\nโข ๐ ุงูููู ุงูุนุงู ูุงููุชุฎุตุต\nโข โ๏ธ ุงูููู ุงููุจุฑุฏ ูุงููุฌูุฏ\nโข ๐ ุงูุชุฎููุต ุงูุฌูุฑูู\nโข ๐ ุงูุชุชุจุน ุงููุจุงุดุฑ\nโข ๐ ุฅุฏุงุฑุฉ ุงูุฃุณุทูู\nโข ๐ผ ุงูุญููู ุงูููุฌุณุชูุฉ\nโข ๐ช ุงูุชูุตูู ูููุชุงุฌุฑ\nโข ๐ญ ุงูููู ุงูุตูุงุนู"
    ]
  },
  
  // Contact
  contact: {
    patterns: ["contact", "ุชูุงุตู", "ุงุชุตุงู", "ุฑูู", "phone", "email", "ุจุฑูุฏ"],
    responses: [
      "๐ ุทุฑู ุงูุชูุงุตู ูุนูุง:\nโข ุงููุงุชู: +966 53 997 7837\nโข ุงูุฑูู ุงูููุญุฏ: 8002440411\nโข ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: info@profleet.app\nโข ุงููููุน: www.profleet.app\n\n๐ ุงูุนููุงู: ุงูุฑูุงุถุ ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ\nโฐ ุฎุฏูุฉ ุงูุนููุงุก: 24/7"
    ]
  },
  
  // Support
  support: {
    patterns: ["help", "ูุณุงุนุฏุฉ", "support", "ุฏุนู", "ูุดููุฉ", "problem", "issue"],
    responses: [
      "๐ ููู ูููููู ูุณุงุนุฏุชูุ\nโข ุชุชุจุน ุงูุดุญูุงุช ูุงูุฑุญูุงุช\nโข ุงูุงุณุชุนูุงู ุนู ุงูุฃุณุนุงุฑ\nโข ุญุฌุฒ ุฑุญูุฉ ุฌุฏูุฏุฉ\nโข ูุดุงูู ุชูููุฉ\nโข ุงุณุชูุณุงุฑุงุช ุนุงูุฉ\n\n๐ ููุฏุนู ุงูููุฑู: +966 53 997 7837\nโฐ ูุชุงุญูู 24/7"
    ]
  },
  
  // Goodbye
  goodbye: {
    patterns: ["bye", "goodbye", "ูุน ุงูุณูุงูุฉ", "ูุฏุงุนุง", "ุดูุฑุง", "thanks", "thank you"],
    responses: [
      "ุดูุฑุงู ูู! ๐\nุฃุชููู ุฃู ุฃููู ูุฏ ุณุงุนุฏุชู\nูุง ุชุชุฑุฏุฏ ูู ุงูุนูุฏุฉ ุฅูู ูู ุฃู ููุช",
      "ูุน ุงูุณูุงูุฉ! ๐\nูุงู ูู ุฏูุงุนู ุณุฑูุฑู ูุณุงุนุฏุชู\nPRO FLEET ูู ุฎุฏูุชู ุฏุงุฆูุงู"
    ]
  },
  
  // Booking and orders
  booking: {
    patterns: ["ุญุฌุฒ", "ุทูุจ", "ุฃุฑูุฏ", "book", "order", "ุงุญุชุงุฌ", "ุนุงูุฒ"],
    responses: [
      "๐ ูุญุฌุฒ ุฑุญูุฉ ุฌุฏูุฏุฉ:\nโข ุงุฐูุจ ูุตูุญุฉ 'ุญุฌุฒ ุฑุญูุฉ'\nโข ุญุฏุฏ ููุทุฉ ุงูุงูุทูุงู ูุงููุฌูุฉ\nโข ุงุฎุชุฑ ููุน ุงููุฑูุจุฉ ูุฏุฑุฌุฉ ุงูุญุฑุงุฑุฉ\nโข ุงุญุตู ุนูู ุนุฑุถ ุณุนุฑ ููุฑู\nโข ุฃููู ุงูุญุฌุฒ ุจุฎุทูุงุช ุจุณูุทุฉ\n\n๐ ุฃู ุชูุงุตู ูุนูุง: +966 53 997 7837"
    ]
  },
  
  // Vehicle types
  vehicles: {
    patterns: ["ูุฑูุจุฉ", "ุดุงุญูุฉ", "ุณูุงุฑุฉ", "vehicle", "truck", "car", "ููู", "transport"],
    responses: [
      "๐ ุฃููุงุน ุงููุฑูุจุงุช ุงููุชุงุญุฉ:\nโข ุดุงุญูุงุช ุตุบูุฑุฉ (1-3 ุทู)\nโข ุดุงุญูุงุช ูุชูุณุทุฉ (3-7 ุทู)\nโข ุดุงุญูุงุช ูุจูุฑุฉ (7-15 ุทู)\nโข ุดุงุญูุงุช ุนููุงูุฉ (+15 ุทู)\nโข ูุฑูุจุงุช ูุจุฑุฏุฉ ููุฌูุฏุฉ\nโข ูุฑูุจุงุช ูุชุฎุตุตุฉ\n\n๐ ูุฎุชุงุฑ ุงููุฑูุจุฉ ุงูููุงุณุจุฉ ุญุณุจ ุญุฌู ููุฒู ุดุญูุชู"
    ]
  },
  
  // Temperature services
  temperature: {
    patterns: ["ูุจุฑุฏ", "ูุฌูุฏ", "ุชุจุฑูุฏ", "ุญุฑุงุฑุฉ", "temperature", "cold", "frozen", "refrigerated"],
    responses: [
      "โ๏ธ ุฎุฏูุงุช ุงูุชุญูู ุจุงูุญุฑุงุฑุฉ:\nโข ๐ก๏ธ ุงูููู ุงูุนุงุฏู (ุญุฑุงุฑุฉ ุงูุฌู)\nโข โ๏ธ ุงูููู ุงููุจุฑุฏ (2-8ยฐู)\nโข ๐ง ุงูููู ุงููุฌูุฏ (-18ยฐู)\nโข ๐ก๏ธ ุฏุฑุฌุงุช ุญุฑุงุฑุฉ ูุฎุตุตุฉ\n\n๐ฅ ูุซุงูู ููุฃุบุฐูุฉ ูุงูุฃุฏููุฉ ูุงูููุชุฌุงุช ุงูุญุณุงุณุฉ"
    ]
  },
  
  // Customs clearance
  customs: {
    patterns: ["ุฌูุงุฑู", "ุชุฎููุต", "customs", "clearance", "ุงุณุชูุฑุงุฏ", "ุชุตุฏูุฑ", "import", "export"],
    responses: [
      "๐ ุฎุฏูุงุช ุงูุชุฎููุต ุงูุฌูุฑูู:\nโข ุชุฎููุต ุงูุจุถุงุฆุน ุงููุณุชูุฑุฏุฉ\nโข ุฅููุงุก ุงูุฅุฌุฑุงุกุงุช ุงูุฌูุฑููุฉ\nโข ุชูุฏูู ุงููุณุชูุฏุงุช ุงููุทููุจุฉ\nโข ูุชุงุจุนุฉ ูุน ุงูุฌูุงุช ุงููุฎุชุตุฉ\nโข ุฎุจุฑุงุก ูุชุฎุตุตูู\n\n๐ ูุณูู ุนููู ุฌููุน ุงูุฅุฌุฑุงุกุงุช ุงูุฌูุฑููุฉ"
    ]
  },
  
  // Problems and complaints
  problems: {
    patterns: ["ูุดููุฉ", "ุดููู", "ุฎุทุฃ", "problem", "issue", "complaint", "error", "ุชุฃุฎูุฑ", "delay"],
    responses: [
      "๐ ูุฃุณู ูุฃู ูุดููุฉ ูุงุฌูุชู!\n\n๐ง ูููุณุงุนุฏุฉ ุงูููุฑูุฉ:\nโข ุงุชุตู ุจูุง: +966 53 997 7837\nโข ุฃุฑุณู ุจุฑูุฏ: info@profleet.app\nโข ุชูุงุตู ุนุจุฑ ุงููููุน\n\nโฐ ูุฑูู ุงูุฏุนู ูุชุงุญ 24/7\n๐ฏ ูุญู ููุชุฒููู ุจุญู ุฌููุน ุงููุดุงูู ุจุณุฑุนุฉ"
    ]
  }
}

// Enhanced response matching function
function findBestResponse(userMessage: string): string {
  const message = userMessage.toLowerCase().trim()
  
  // Check for trip number pattern first
  const proMatch = message.match(/pro[\-\s]?(\d{8})[\-\s]?(\d{3})/i)
  if (proMatch) {
    const tripNumber = `PRO-${proMatch[1]}-${proMatch[2]}`
    return `๐ฆ ุงูุจุญุซ ุนู ุงูุฑุญูุฉ ${tripNumber}...\n\n๐ ููุญุตูู ุนูู ูุนูููุงุช ููุตูุฉ ุนู ุงูุฑุญูุฉ:\nโข ุชุฃูุฏ ูู ุชุณุฌูู ุงูุฏุฎูู\nโข ุงุฐูุจ ูุตูุญุฉ 'ุชุชุจุน ุงูุดุญูุงุช'\nโข ุฃู ุงุฐูุจ ูุตูุญุฉ 'ุฑุญูุงุชู'\n\n๐ ูููุณุงุนุฏุฉ: +966 53 997 7837`
  }
  
  // Smart question analysis
  const questionWords = ["ููู", "ูุงุฐุง", "ูุชู", "ุฃูู", "ููุงุฐุง", "ูู", "what", "how", "when", "where", "why", "who"]
  const isQuestion = questionWords.some(word => message.includes(word)) || message.includes("ุ") || message.includes("?")
  
  // Check for multiple topics in one message
  let matchedCategories: string[] = []
  let bestResponse = ""
  
  // Check each category for matches
  for (const [category, data] of Object.entries(chatbotResponses)) {
    for (const pattern of data.patterns) {
      if (message.includes(pattern.toLowerCase())) {
        matchedCategories.push(category)
        if (!bestResponse) {
          const responses = data.responses
          bestResponse = responses[Math.floor(Math.random() * responses.length)]
        }
        break
      }
    }
  }
  
  // Handle multiple topics
  if (matchedCategories.length > 1) {
    const topics = matchedCategories.map(cat => {
      switch(cat) {
        case 'tracking': return 'ุชุชุจุน ุงูุดุญูุงุช'
        case 'pricing': return 'ุงูุฃุณุนุงุฑ'
        case 'services': return 'ุงูุฎุฏูุงุช'
        case 'company': return 'ูุนูููุงุช ุงูุดุฑูุฉ'
        case 'contact': return 'ุงูุชูุงุตู'
        default: return cat
      }
    }).join(' ู ')
    
    return `๐ค ุฃุฑู ุฃูู ุชุณุฃู ุนู ${topics}.\n\n${bestResponse}\n\n๐ก ูู ุชุฑูุฏ ูุนูููุงุช ุฃูุซุฑ ุชูุตููุงู ุนู ุฃู ูู ูุฐู ุงูููุงุถูุนุ`
  }
  
  // Handle questions with context
  if (isQuestion && bestResponse) {
    return `โ ${bestResponse}\n\n๐ ูู ูุฐุง ูุฌูุจ ุนูู ุณุคุงููุ ุฅุฐุง ููุช ุชุญุชุงุฌ ูุนูููุงุช ุฃูุซุฑ ุชูุตููุงูุ ููุท ุงุณุฃู!`
  }
  
  // Return best match if found
  if (bestResponse) {
    return bestResponse
  }
  
  // Handle specific keywords that might not be in main patterns
  const specificKeywords = {
    "ูุงุชูุฑุฉ": "๐ฐ ููุงุณุชุนูุงู ุนู ุงูููุงุชูุฑ:\nโข ุงุฐูุจ ูุตูุญุฉ 'ููุงุชูุฑู'\nโข ุชุงุจุน ุญุงูุฉ ุงูุฏูุน\nโข ุญูู ุงููุงุชูุฑุฉ PDF\nโข ุณุฌู ุฏูุนุฉ ุฌุฏูุฏุฉ\n\n๐ ูููุณุงุนุฏุฉ: +966 53 997 7837",
    "ุฏูุน": "๐ณ ุทุฑู ุงูุฏูุน ุงููุชุงุญุฉ:\nโข ุงูุฏูุน ุงูููุฏู\nโข ุงูุชุญููู ุงูุจููู\nโข ุงูุจุทุงูุงุช ุงูุงุฆุชูุงููุฉ\nโข ุงููุญุงูุธ ุงูุฑูููุฉ\nโข ุงูุฏูุน ุจุงูุฃูุณุงุท\n\n๐ฐ ุฏูุน ุขูู ููุถููู",
    "ุณุงุฆู": "๐จโ๐ผ ูุนูููุงุช ุงูุณุงุฆููู:\nโข ุณุงุฆููู ูุฏุฑุจูู ููุคูููู\nโข ุฎุจุฑุฉ ูุงุณุนุฉ ูู ุงูููู\nโข ุชุชุจุน ูุจุงุดุฑ ูููููุน\nโข ุงูุชุฒุงู ุจุงูููุงุนูุฏ\nโข ุฎุฏูุฉ ุงุญุชุฑุงููุฉ\n\n๐ ุฃูุถู ุงูุณุงุฆููู ูู ุงูููููุฉ",
    "ุฃูุงู": "๐ก๏ธ ุถูุงูุงุช ุงูุฃูุงู:\nโข ุชุฃููู ุดุงูู ุนูู ุงูุจุถุงุฆุน\nโข ุณุงุฆููู ูุคูููู ููุฏุฑุจูู\nโข ูุฑูุจุงุช ุญุฏูุซุฉ ูููุญูุตุฉ\nโข ุชุชุจุน ูุจุงุดุฑ 24/7\nโข ุฎุฏูุฉ ุนููุงุก ูุณุชูุฑุฉ\n\nโ ุฃูุงูู ูุฃูุงู ุจุถุงุฆุนู ุฃููููุชูุง"
  }
  
  for (const [keyword, response] of Object.entries(specificKeywords)) {
    if (message.includes(keyword)) {
      return response
    }
  }
  
  // Smart default response based on message content
  if (message.length < 3) {
    return "๐ค ุฑุณุงูุฉ ูุตูุฑุฉ ุฌุฏุงู! ููููู ูุชุงุจุฉ ุณุคุงู ุฃู ุทูุจ ุฃูุซุฑ ุชูุตููุงู ูุณุฃููู ุณุนูุฏุงู ููุณุงุนุฏุชู."
  }
  
  if (isQuestion) {
    return "โ ุณุคุงู ุฑุงุฆุน! ููู ูู ุฃุชููู ูู ูููู ุชูุงูุงู.\n\n๐ก ููููู ุงูุณุคุงู ุนู:\nโข ุชุชุจุน ุงูุดุญูุงุช (ุฃุฏุฎู ุฑูู ุงูุฑุญูุฉ)\nโข ุงูุฃุณุนุงุฑ ูุงูุชูุงููู\nโข ุฃููุงุน ุงููุฑูุจุงุช ูุงูุฎุฏูุงุช\nโข ุงูุชุฎููุต ุงูุฌูุฑูู\nโข ูุนูููุงุช ุงูุดุฑูุฉ ูุงูุชูุงุตู\n\n๐ ุฃู ุชูุงุตู ูุจุงุดุฑุฉ: +966 53 997 7837"
  }
  
  // Default response with helpful suggestions
  return "๐ค ุนุฐุฑุงูุ ูู ุฃููู ุทูุจู ุชูุงูุงู.\n\n๐ก ููููู ุงูุณุคุงู ุนู:\nโข ุชุชุจุน ุงูุดุญูุงุช (ุฃุฏุฎู ุฑูู ุงูุฑุญูุฉ)\nโข ุงูุฃุณุนุงุฑ ูุงูุชูุงููู\nโข ุญุฌุฒ ุฑุญูุฉ ุฌุฏูุฏุฉ\nโข ุฎุฏูุงุชูุง ููุนูููุงุช ุงูุดุฑูุฉ\nโข ุงูุฏุนู ูุงููุณุงุนุฏุฉ\n\n๐ ุฃู ุชูุงุตู ูุจุงุดุฑุฉ: +966 53 997 7837\n\n๐ฌ ุฌุฑุจ ุฃู ุชููู ุฃูุซุฑ ุชุญุฏูุฏุงู ูู ุณุคุงูู!"
}

// POST - Send message to simple chatbot
export async function POST(req: NextRequest) {
  try {
    const body = await req.json()
    const { message } = body

    if (!message) {
      return NextResponse.json(
        { error: "Message is required" },
        { status: 400 }
      )
    }

    // Get bot response
    const botResponse = findBestResponse(message)

    return NextResponse.json({
      botResponse,
      timestamp: new Date().toISOString(),
      userRole: "ูุณุชุฎุฏู",
      userName: "ุถูู"
    })

  } catch (error) {
    console.error("Error in simple chat:", error)
    return NextResponse.json(
      { 
        botResponse: "โ ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูุคูุช.\n\n๐ ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู\n๐ ุฃู ุชูุงุตู ูุนูุง: +966 53 997 7837",
        timestamp: new Date().toISOString(),
        error: "Internal server error" 
      },
      { status: 500 }
    )
  }
}

// GET - Get simple bot info
export async function GET() {
  return NextResponse.json({
    botInfo: {
      name: "PRO FLEET Assistant",
      version: "2.0 Simple",
      capabilities: [
        "ุชุชุจุน ุงูุดุญูุงุช ุงูุฃุณุงุณู",
        "ุงูุงุณุชุนูุงู ุนู ุงูุฃุณุนุงุฑ", 
        "ูุนูููุงุช ุงูุดุฑูุฉ ูุงูุฎุฏูุงุช",
        "ุงูุฏุนู ูุงููุณุงุนุฏุฉ"
      ]
    },
    suggestions: [
      {
        type: "tracking",
        title: "ุชุชุจุน ุงูุดุญูุฉ",
        message: "ุฃุฏุฎู ุฑูู ุงูุฑุญูุฉ ููุชุชุจุน",
        action: "PRO-20241224-001",
        priority: "high"
      },
      {
        type: "pricing", 
        title: "ุงูุฃุณุนุงุฑ",
        message: "ุงุณุชุนูู ุนู ุฃุณุนุงุฑ ุงูููู",
        action: "ุงูุฃุณุนุงุฑ",
        priority: "medium"
      },
      {
        type: "booking",
        title: "ุญุฌุฒ ุฑุญูุฉ",
        message: "ุงุญุฌุฒ ุฑุญูุฉ ุฌุฏูุฏุฉ ุงูุขู",
        action: "ุฃุฑูุฏ ุญุฌุฒ ุฑุญูุฉ",
        priority: "high"
      },
      {
        type: "vehicles",
        title: "ุฃููุงุน ุงููุฑูุจุงุช",
        message: "ุชุนุฑู ุนูู ุฃููุงุน ุงููุฑูุจุงุช",
        action: "ุฃููุงุน ุงููุฑูุจุงุช",
        priority: "medium"
      },
      {
        type: "support",
        title: "ุงูุฏุนู ุงูููู",
        message: "ุงุญุตู ุนูู ุงููุณุงุนุฏุฉ",
        action: "ุฃุญุชุงุฌ ูุณุงุนุฏุฉ",
        priority: "low"
      }
    ]
  })
}
