# سكريبتات تنظيف وإعادة تهيئة البيانات

## نظرة عامة

هذه السكريبتات تساعد في تنظيف وإعادة تهيئة بيانات المدن والتسعير في النظام.

## السكريبتات المتاحة

### 1. تنظيف المدن (`cleanup-cities.js`)

يقوم هذا السكريبت بـ:
- حذف جميع الرحلات المرتبطة بالمدن
- حذف جميع أسعار التسعير
- حذف الفواتير المرتبطة
- حذف سجلات التتبع
- حذف العناوين المحفوظة
- حذف جميع المدن القديمة
- إضافة 15 مدينة سعودية جديدة ونظيفة

**الاستخدام:**
```bash
npm run db:cleanup-cities
```

### 2. إنشاء التسعير الأساسي (`seed-pricing.js`)

يقوم هذا السكريبت بـ:
- إنشاء تسعير أساسي بين المدن الرئيسية
- حساب الأسعار بناءً على المسافة ونوع المركبة
- يعمل فقط مع المدن الرئيسية (الرياض، جدة، الدمام، مكة، المدينة)

**الاستخدام:**
```bash
npm run db:seed-pricing
```

### 3. البداية الجديدة (`db:fresh-start`)

يقوم بتشغيل السكريبتين معاً للحصول على بداية نظيفة:

**الاستخدام:**
```bash
npm run db:fresh-start
```

## المدن المضافة

السكريبت يضيف المدن التالية:

1. **الرياض** (Riyadh)
2. **جدة** (Jeddah)  
3. **الدمام** (Dammam)
4. **مكة المكرمة** (Mecca)
5. **المدينة المنورة** (Medina)
6. **الخبر** (Khobar)
7. **الطائف** (Taif)
8. **تبوك** (Tabuk)
9. **بريدة** (Buraidah)
10. **خميس مشيط** (Khamis Mushait)
11. **حائل** (Hail)
12. **الهفوف** (Hofuf)
13. **الجبيل** (Jubail)
14. **ينبع** (Yanbu)
15. **أبها** (Abha)

## ملاحظات مهمة

⚠️ **تحذير:** هذه السكريبتات تحذف جميع البيانات المرتبطة بالمدن. تأكد من عمل نسخة احتياطية قبل التشغيل.

🔄 **الترتيب:** يجب تشغيل `cleanup-cities` قبل `seed-pricing`

📊 **التسعير:** السكريبت ينشئ تسعير أساسي فقط. يمكنك إضافة المزيد من الأسعار يدوياً من لوحة الإدارة.

🚛 **المركبات:** تأكد من وجود مركبات في النظام قبل تشغيل سكريبت التسعير.

---

# سكريپتات مزامنة المدفوعات والأقساط

## نظرة عامة

هذه السكريپتات تساعد في مزامنة وتصحيح حسابات المدفوعات والأقساط لجميع الفواتير في النظام.

## السكريپتات المتاحة

### 1. مزامنة شاملة (`sync-payments`)

يقوم بمزامنة جميع الفواتير (العادية وفواتير التخليص الجمركي):

**الاستخدام:**
```bash
npm run sync-payments
# أو
node scripts/run-payment-sync.js
```

### 2. مزامنة الفواتير العادية (`sync-payments:regular`)

يقوم بمزامنة الفواتير العادية فقط:

**الاستخدام:**
```bash
npm run sync-payments:regular
# أو
node scripts/run-payment-sync.js --type=regular
```

### 3. مزامنة فواتير التخليص الجمركي (`sync-payments:clearance`)

يقوم بمزامنة فواتير التخليص الجمركي فقط:

**الاستخدام:**
```bash
npm run sync-payments:clearance
# أو
node scripts/run-payment-sync.js --type=clearance
```

## ما تقوم به المزامنة

السكريپتات تقوم بـ:

- **إعادة حساب المبالغ المدفوعة** بناءً على المدفوعات الفعلية
- **تحديث المبالغ المتبقية** بدقة
- **تصحيح حالات الدفع** (PENDING, PAID, PARTIAL, INSTALLMENT, OVERDUE)
- **حساب عدد الأقساط المدفوعة** بناءً على المدفوعات الفعلية
- **تحديد مواعيد الأقساط التالية** للفواتير المقسطة
- **تحديد تاريخ الدفع الكامل** للفواتير المدفوعة بالكامل
- **معالجة الفواتير المتأخرة** بناءً على تاريخ الاستحقاق

## واجهة الإدارة

يمكن أيضاً تشغيل المزامنة من واجهة الإدارة:

1. اذهب إلى `/admin/sync-payments`
2. اعرض الإحصائيات والحالة الحالية
3. اختر نوع المزامنة المطلوب
4. راقب النتائج والتقارير

## الميزات

✅ **آمن:** يتحقق من البيانات قبل التحديث
✅ **مفصل:** يعرض تقارير مفصلة عن النتائج
✅ **مرن:** يمكن تشغيله لنوع واحد أو جميع الفواتير
✅ **سريع:** يعالج آلاف الفواتير في ثوانٍ
✅ **موثوق:** يستخدم نفس منطق APIs الإنتاج

## ملاحظات مهمة

⚠️ **نسخة احتياطية:** تأكد من عمل backup قبل التشغيل

🔄 **إعادة التشغيل:** آمن لإعادة التشغيل عدة مرات

📊 **التقارير:** يعرض إحصائيات مفصلة بعد المزامنة

⏱️ **الوقت:** قد يستغرق وقتاً حسب عدد الفواتير

🔐 **الصلاحيات:** يتطلب صلاحيات ADMIN للتشغيل من الواجهة
