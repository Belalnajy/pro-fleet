# سكريبتات إصلاح فواتير التخليص الجمركي

## المشكلة
عندما ينشئ المخلص الجمركي تخليص جمركي جديد، كان النظام ينشئ `CustomsClearance` فقط بدون إنشاء `CustomsClearanceInvoice` المطلوبة لظهور الفاتورة للعميل.

## الحل المطبق

### 1. إصلاح API إنشاء التخليص الجمركي
تم تحديث `/src/app/api/customs-broker/clearances/route.ts` لإنشاء:
- `CustomsClearance` (التخليص الجمركي)
- `CustomsClearanceInvoice` (فاتورة التخليص الجمركي) تلقائياً

### 2. سكريبتات الإصلاح

#### `debug-clearance-invoice.js`
سكريبت للتحقق من فاتورة معينة ومعرفة حالة التخليص الجمركي:
```bash
node scripts/debug-clearance-invoice.js
```

#### `fix-missing-clearance-invoices.js`
سكريبت لإصلاح جميع التخليصات الموجودة التي لا تحتوي على فواتير:
```bash
npm run db:fix-clearance-invoices
# أو
node scripts/fix-missing-clearance-invoices.js
```

## النتائج

### قبل الإصلاح:
- المخلص الجمركي ينشئ تخليص جمركي ✅
- لا يتم إنشاء فاتورة تخليص جمركي ❌
- العميل لا يرى الفاتورة في صفحة فواتير التخليص الجمركي ❌

### بعد الإصلاح:
- المخلص الجمركي ينشئ تخليص جمركي ✅
- يتم إنشاء فاتورة تخليص جمركي تلقائياً ✅
- العميل يرى الفاتورة في صفحة فواتير التخليص الجمركي ✅

## تفاصيل فاتورة التخليص الجمركي

### الحقول المحسوبة:
- `subtotal`: مجموع الرسوم الجمركية والإضافية
- `taxRate`: 15% ضريبة القيمة المضافة
- `taxAmount`: قيمة الضريبة المحسوبة
- `total`: المجموع النهائي شامل الضريبة
- `remainingAmount`: المبلغ المتبقي (يساوي total في البداية)
- `dueDate`: تاريخ الاستحقاق (30 يوم أو تاريخ الإنجاز المتوقع)

### رقم الفاتورة:
- تنسيق: `CI-XXXXXX` (CI = Clearance Invoice)
- ترقيم تسلسلي تلقائي

## الاستخدام المستقبلي

### للتخليصات الجديدة:
عند إنشاء تخليص جمركي جديد، سيتم إنشاء الفاتورة تلقائياً.

### للتخليصات الموجودة:
إذا تم اكتشاف تخليصات بدون فواتير، يمكن تشغيل:
```bash
npm run db:fix-clearance-invoices
```

## التحقق من النجاح
بعد تشغيل السكريبت، يمكن للعميل رؤية فواتير التخليص الجمركي في:
- `/customer/clearance-invoices` - صفحة فواتير التخليص الجمركي
- Dashboard العميل - إحصائيات فواتير التخليص

## ملاحظات مهمة
- السكريبت آمن ولا يؤثر على البيانات الموجودة
- يتم إنشاء فواتير فقط للتخليصات التي لا تحتوي على فواتير
- جميع الحسابات تتم وفقاً للمعايير المحاسبية (15% ضريبة قيمة مضافة)
- يتم حفظ جميع البيانات الأصلية للتخليص في الفاتورة
