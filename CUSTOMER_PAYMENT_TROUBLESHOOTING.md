# دليل استكشاف أخطاء نظام الدفع للعملاء

## المشاكل المحتملة وحلولها

### 1. مشكلة تحديد نوع الفاتورة

**المشكلة**: النظام لا يميز بين الفواتير العادية وفواتير التخليص الجمركي بشكل صحيح.

**الحل المطبق**:
- إضافة حقل `invoiceType` للتمييز بين نوعي الفواتير
- تحديد API endpoint الصحيح بناءً على نوع الفاتورة
- إصلاح منطق `onPaymentAdded` callback

### 2. مشاكل APIs الدفع

**APIs المستخدمة**:
- `/api/customer/invoices/[id]/payments` - للفواتير العادية
- `/api/customer/clearance-invoices/[id]/payments` - لفواتير التخليص الجمركي

**نماذج قاعدة البيانات**:
- `Payment` - للفواتير العادية
- `ClearancePayment` - لفواتير التخليص الجمركي

### 3. خطوات الاختبار

#### اختبار الفواتير العادية:
1. تسجيل الدخول كعميل
2. الذهاب إلى صفحة الفواتير `/customer/invoices`
3. اختيار فاتورة عادية (تحتوي على `customsFees = 0`)
4. الضغط على "إدارة المدفوعات"
5. إضافة دفعة جديدة
6. التحقق من تحديث المبلغ المتبقي

#### اختبار فواتير التخليص الجمركي:
1. تسجيل الدخول كعميل
2. الذهاب إلى صفحة الفواتير `/customer/invoices`
3. التبديل إلى تبويب "فواتير التخليص الجمركي"
4. اختيار فاتورة تخليص جمركي
5. الضغط على "إدارة المدفوعات"
6. إضافة دفعة جديدة
7. التحقق من تحديث المبلغ المتبقي

### 4. بيانات الاختبار

**بيانات الدخول للعميل**:
```
البريد الإلكتروني: customer1@company.com
كلمة المرور: demo123
```

**فواتير متاحة للاختبار**:
- فاتورة عادية: PRO-INV-20250923019 (2746.2 ريال)
- فاتورة تخليص: PRO-CLR-20250923001 (747.21 ريال)

### 5. رسائل الخطأ المحتملة

#### خطأ "طريقة الدفع مطلوبة":
```
يرجى اختيار طريقة الدفع
```
**الحل**: التأكد من اختيار طريقة دفع من القائمة المنسدلة

#### خطأ "المبلغ أكبر من المبلغ المتبقي":
```
المبلغ أكبر من المبلغ المتبقي
```
**الحل**: إدخال مبلغ أقل من أو يساوي المبلغ المتبقي

#### خطأ "الفاتورة مدفوعة بالكامل":
```
Invoice already paid
```
**الحل**: اختيار فاتورة أخرى غير مدفوعة بالكامل

### 6. فحص الشبكة (Network Tab)

عند إضافة دفعة، تحقق من:

**للفواتير العادية**:
```
POST /api/customer/invoices/[id]/payments
Content-Type: application/json

{
  "amount": 100,
  "paymentMethod": "cash",
  "reference": "REF123",
  "notes": "ملاحظات الدفع"
}
```

**لفواتير التخليص الجمركي**:
```
POST /api/customer/clearance-invoices/[id]/payments
Content-Type: application/json

{
  "amount": 100,
  "paymentMethod": "bank_transfer",
  "reference": "REF456",
  "notes": "ملاحظات دفع التخليص"
}
```

### 7. فحص قاعدة البيانات

**للتحقق من المدفوعات العادية**:
```sql
SELECT * FROM payments WHERE invoice_id = 'INVOICE_ID';
```

**للتحقق من مدفوعات التخليص**:
```sql
SELECT * FROM clearance_payments WHERE invoice_id = 'CLEARANCE_INVOICE_ID';
```

### 8. سكريبتات الاختبار

**اختبار نظام الدفع**:
```bash
node scripts/test-customer-payments.js
```

**اختبار APIs الدفع**:
```bash
node scripts/test-payment-apis.js
```

### 9. الإصلاحات المطبقة

1. **إضافة تمييز نوع الفاتورة**:
   - حقل `invoiceType` في interface
   - تحديد النوع عند فتح نافذة الدفع

2. **إصلاح API endpoint selection**:
   - استخدام `invoiceType` بدلاً من `customsFees > 0`
   - ضمان استخدام API الصحيح لكل نوع فاتورة

3. **إصلاح callback functions**:
   - `handlePaymentAdded` للفواتير العادية
   - `handleClearancePaymentAdded` لفواتير التخليص

### 10. حالة النظام الحالية

✅ **APIs الدفع تعمل بشكل صحيح**
✅ **قاعدة البيانات تحتوي على بيانات اختبار**
✅ **حسابات المبالغ المتبقية صحيحة**
✅ **تمييز نوع الفاتورة مطبق**

### 11. خطوات التشخيص السريع

1. **فتح Developer Tools** (F12)
2. **الذهاب إلى Network Tab**
3. **محاولة إضافة دفعة**
4. **فحص الطلبات المرسلة**:
   - هل يتم إرسال الطلب للـ API الصحيح؟
   - هل البيانات المرسلة صحيحة؟
   - ما هو رد الخادم؟

5. **فحص Console Tab**:
   - هل توجد أخطاء JavaScript؟
   - هل تظهر رسائل خطأ؟

### 12. الاتصال بالدعم

إذا استمرت المشكلة، يرجى تقديم:
- لقطة شاشة من رسالة الخطأ
- لقطة شاشة من Network Tab
- تفاصيل الفاتورة المستخدمة في الاختبار
- خطوات إعادة إنتاج المشكلة
