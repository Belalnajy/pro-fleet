# 🚀 نظام التتبع المباشر للسائقين - Live Driver Tracking System

## نظرة عامة
تم تطوير نظام التتبع المباشر لتمكين الأدمن من مراقبة مواقع السائقين في الوقت الفعلي عند قبولهم للرحلات. يوفر النظام تتبعاً مباشراً لمواقع السائقين مع عرض تفاعلي على الخرائط.

## الميزات الرئيسية

### 🎯 للسائقين
- **صفحة التتبع المباشر**: `/driver/live-tracking`
- إرسال الموقع تلقائياً كل 5 ثوانٍ عند قبول الرحلة
- عرض الموقع الحالي على خريطة تفاعلية
- إحصائيات التتبع (عدد النقاط المُرسلة، حالة الاتصال)
- التحكم في بدء/إيقاف التتبع
- تحديث حالة الرحلة إلى "مُسلمة"

### 🎯 للأدمن
- **صفحة التتبع المباشر**: `/admin/live-tracking`
- مراقبة جميع السائقين النشطين
- عرض إحصائيات شاملة (رحلات نشطة، سائقين متصلين)
- البحث والتصفية حسب الحالة والسائق
- عرض قائمة مفصلة أو خريطة شاملة
- التحكم في تفعيل/إيقاف التتبع للسائقين

## المكونات التقنية

### 📡 APIs الجديدة

#### 1. Driver Tracking API
**المسار**: `/api/driver/tracking`

**POST** - إرسال موقع السائق:
```json
{
  "tripId": "trip_id",
  "latitude": 24.7136,
  "longitude": 46.6753,
  "speed": 60,
  "heading": 180
}
```

**GET** - جلب سجلات التتبع:
```json
{
  "tripId": "trip_id",
  "limit": 50
}
```

#### 2. Admin Tracking API
**المسار**: `/api/admin/tracking`

**GET** - جلب بيانات التتبع:
- `?activeOnly=true` - الرحلات النشطة فقط

**PUT** - التحكم في التتبع:
```json
{
  "driverId": "driver_id",
  "trackingEnabled": true
}
```

### 🗺️ مكونات الخرائط

#### EnhancedLiveTrackingMap
مكون خريطة محسن يوفر:
- عرض الموقع الحالي للسائق
- مسار التتبع (Trail)
- نقاط البداية والوجهة
- أدوات التحكم (توسيط، تكبير، ملء الشاشة)
- معلومات الحالة والاتصال

### 📱 صفحات المستخدم

#### صفحة السائق - Live Tracking
**المسار**: `/driver/live-tracking?tripId=xxx`

**الميزات**:
- عرض معلومات الرحلة الحالية
- خريطة تفاعلية للموقع الحالي
- إحصائيات التتبع المباشر
- أزرار التحكم (بدء/إيقاف التتبع، تسليم الرحلة)

#### صفحة الأدمن - Live Tracking
**المسار**: `/admin/live-tracking`

**الميزات**:
- إحصائيات شاملة للنظام
- قائمة مفصلة بجميع الرحلات النشطة
- خريطة شاملة لجميع السائقين
- أدوات البحث والتصفية
- التحكم في إعدادات التتبع

## تدفق العمل

### 1. قبول الرحلة
```
السائق يقبل الرحلة → تفعيل التتبع تلقائياً → بدء إرسال الموقع
```

### 2. التتبع المباشر
```
السائق يرسل الموقع كل 5 ثوانٍ → حفظ في قاعدة البيانات → عرض للأدمن
```

### 3. مراقبة الأدمن
```
الأدمن يفتح صفحة التتبع → عرض جميع السائقين النشطين → مراقبة مباشرة
```

## قاعدة البيانات

### جدول TrackingLog
```sql
- id: String (Primary Key)
- driverId: String (Foreign Key)
- tripId: String (Foreign Key)
- latitude: Float
- longitude: Float
- speed: Float
- heading: Float
- timestamp: DateTime
```

### تحديثات جدول Driver
```sql
- trackingEnabled: Boolean (جديد)
- currentLocation: String (محدث)
```

## الأمان والخصوصية

### 🔒 التحكم في الوصول
- السائقون: يمكنهم إرسال مواقعهم فقط
- الأدمن: يمكنهم مراقبة جميع السائقين والتحكم في التتبع
- العملاء: لا يمكنهم الوصول لبيانات التتبع المباشر

### 🛡️ حماية البيانات
- تشفير البيانات المُرسلة عبر HTTPS
- التحقق من صحة المستخدم قبل كل طلب
- تحديد عدد النقاط المحفوظة لتجنب امتلاء قاعدة البيانات

## الأداء والتحسين

### ⚡ تحسينات الأداء
- إرسال الموقع كل 5 ثوانٍ (قابل للتخصيص)
- حفظ آخر 50 نقطة فقط لكل سائق
- تحديث تلقائي للأدمن كل 10 ثوانٍ
- استخدام Leaflet للخرائط (خفيف وسريع)

### 📊 مراقبة الأداء
- عداد النقاط المُرسلة
- حالة الاتصال (متصل/غير متصل)
- وقت آخر تحديث
- إحصائيات شاملة للنظام

## التطوير المستقبلي

### 🔮 ميزات مقترحة
1. **إشعارات فورية**: Socket.IO للتحديثات الفورية
2. **تتبع المسار**: حفظ وعرض المسار الكامل للرحلة
3. **تنبيهات ذكية**: تنبيهات عند الخروج عن المسار أو التوقف الطويل
4. **تحليلات متقدمة**: تقارير عن أداء السائقين وأوقات الرحلات
5. **تتبع للعملاء**: السماح للعملاء بمراقبة رحلاتهم

### 🛠️ تحسينات تقنية
1. **WebSocket**: للتحديثات الفورية بدلاً من Polling
2. **Service Workers**: للعمل في الخلفية حتى عند إغلاق التطبيق
3. **Offline Support**: حفظ المواقع محلياً وإرسالها عند الاتصال
4. **Push Notifications**: إشعارات للأدمن عند الأحداث المهمة

## الاستخدام

### للسائقين
1. قبول رحلة من صفحة الرحلات
2. الانتقال لصفحة التتبع المباشر
3. بدء التتبع (تلقائي عند قبول الرحلة)
4. مراقبة الموقع على الخريطة
5. تحديث حالة الرحلة عند التسليم

### للأدمن
1. فتح صفحة التتبع المباشر
2. مراجعة الإحصائيات العامة
3. البحث عن رحلة أو سائق محدد
4. مراقبة المواقع على الخريطة
5. التحكم في إعدادات التتبع حسب الحاجة

## الدعم والصيانة

### 🔧 استكشاف الأخطاء
- التحقق من إذن الموقع في المتصفح
- التأكد من الاتصال بالإنترنت
- مراجعة console logs للأخطاء
- التحقق من حالة الخادم

### 📞 الدعم التقني
- مراجعة ملفات السجل (logs)
- مراقبة أداء قاعدة البيانات
- تحديث المكونات حسب الحاجة
- النسخ الاحتياطي المنتظم للبيانات

---

## ملاحظات المطور

تم تطوير هذا النظام باستخدام:
- **Next.js 14** مع App Router
- **TypeScript** للأمان التقني
- **Prisma** لقاعدة البيانات
- **Leaflet** للخرائط
- **Tailwind CSS** للتصميم
- **NextAuth.js** للمصادقة

النظام جاهز للاستخدام ويمكن تطويره أكثر حسب احتياجات المشروع.
