# نظام حساب العمولة بالنسبة المئوية - Percentage-Based Commission System

## 📋 نظرة عامة

تم تطوير نظام متقدم لحساب رسوم التخليص الجمركي يدعم كلاً من:
- **المبالغ الثابتة** (Fixed Amounts)
- **النسب المئوية** (Percentage-Based)

هذا النظام يوفر مرونة أكبر للمخلصين الجمركيين في تحديد رسومهم بناءً على قيمة الفاتورة.

## 🎯 الميزات الجديدة

### 1. **أنواع الرسوم المدعومة:**
- **رسوم ثابتة**: مبلغ محدد بالريال السعودي
- **رسوم بالنسبة المئوية**: نسبة من إجمالي قيمة الفاتورة

### 2. **حقول قاعدة البيانات الجديدة:**
```sql
-- في جدول customs_clearances
customsFeeType          VARCHAR DEFAULT 'FIXED'
customsFeePercentage    FLOAT   DEFAULT 0
additionalFeesType      VARCHAR DEFAULT 'FIXED' 
additionalFeesPercentage FLOAT  DEFAULT 0
```

### 3. **واجهة المستخدم المحسنة:**
- اختيار نوع الرسوم (ثابت أو نسبة مئوية)
- معاينة فورية للمبلغ المحسوب
- دعم متعدد اللغات (عربي، إنجليزي، أردو)

## 🔧 كيفية الاستخدام

### للمخلص الجمركي:

1. **اختيار نوع الرسوم الجمركية:**
   - **مبلغ ثابت**: أدخل المبلغ بالريال
   - **نسبة مئوية**: أدخل النسبة (مثال: 5%)

2. **اختيار نوع الرسوم الإضافية:**
   - **مبلغ ثابت**: أدخل المبلغ بالريال
   - **نسبة مئوية**: أدخل النسبة (مثال: 2.5%)

3. **معاينة المبلغ:**
   - يتم عرض المبلغ المحسوب تلقائياً
   - يعتمد الحساب على إجمالي قيمة الفاتورة المختارة

## 📊 أمثلة الحسابات

### مثال 1: فاتورة بقيمة 2000 ريال

**السيناريو الأول - رسوم ثابتة:**
- رسوم جمركية: 500 ريال (ثابت)
- رسوم إضافية: 200 ريال (ثابت)
- **المجموع**: 700 ريال

**السيناريو الثاني - رسوم بالنسبة:**
- رسوم جمركية: 5% = 100 ريال
- رسوم إضافية: 2% = 40 ريال
- **المجموع**: 140 ريال

**السيناريو الثالث - مختلط:**
- رسوم جمركية: 300 ريال (ثابت)
- رسوم إضافية: 1.5% = 30 ريال
- **المجموع**: 330 ريال

## 🛠️ التطبيق التقني

### 1. **تحديث قاعدة البيانات:**
```bash
npx prisma migrate dev --name add-percentage-calculations
npx prisma generate
```

### 2. **API المحدث:**
```javascript
// في /api/customs-broker/clearances
const actualCustomsFee = customsFeeType === 'PERCENTAGE' 
  ? (invoice.total * customsFeePercentage) / 100
  : customsFee || 0
```

### 3. **الواجهة المحدثة:**
- اختيار نوع الرسوم
- حقول إدخال منفصلة للمبالغ والنسب
- معاينة فورية للحسابات

## 🧪 الاختبار

### تشغيل اختبارات الحسابات:
```bash
npm run test:percentage-calculations
```

### سيناريوهات الاختبار:
1. **رسوم ثابتة فقط**
2. **رسوم جمركية بالنسبة + رسوم إضافية ثابتة**
3. **رسوم جمركية ثابتة + رسوم إضافية بالنسبة**
4. **كلا النوعين بالنسبة المئوية**

## 📈 الفوائد

### للمخلصين الجمركيين:
- **مرونة في التسعير**: اختيار الطريقة الأنسب لكل حالة
- **عدالة في الرسوم**: ربط الرسوم بقيمة الشحنة
- **سهولة الحساب**: معاينة فورية للمبالغ

### للعملاء:
- **شفافية أكبر**: فهم طريقة حساب الرسوم
- **عدالة في التكلفة**: رسوم متناسبة مع قيمة الشحنة

### للنظام:
- **مرونة تقنية**: دعم أنواع متعددة من الحسابات
- **قابلية التوسع**: إمكانية إضافة أنواع جديدة من الرسوم

## 🔄 التحديثات المستقبلية

### مقترحات للتطوير:
1. **رسوم متدرجة**: نسب مختلفة حسب قيمة الفاتورة
2. **رسوم حسب نوع البضاعة**: نسب مختلفة لأنواع مختلفة
3. **خصومات تلقائية**: للعملاء المميزين
4. **تقارير تحليلية**: مقارنة الرسوم الثابتة والنسبية

## 📞 الدعم

لأي استفسارات أو مشاكل تقنية، يرجى التواصل مع فريق التطوير.

---

**تاريخ التحديث**: 2025-01-23  
**الإصدار**: 1.0.0  
**المطور**: فريق Pro Fleet
