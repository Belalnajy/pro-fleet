# حلول مشكلة امتلاء قاعدة البيانات 📊

## المشكلة الحالية
قاعدة البيانات وصلت لـ 100% من الحد المسموح (0.54 GB) مما يمنع العمليات الجديدة.

## الحلول المتاحة (بدلاً من الـ Upgrade)

### 1. 🚨 الحل الطارئ (فوري)
```bash
npm run db:emergency-cleanup
```
**ما يفعله:**
- حذف جميع tracking logs أقدم من أسبوعين
- حذف جميع الإشعارات المقروءة
- حذف الإشعارات القديمة غير المقروءة (أقدم من شهر)
- حذف الجلسات المنتهية
- حذف رموز التحقق المنتهية

**النتيجة المتوقعة:** توفير 70-90% من المساحة

### 2. 📊 تحليل البيانات أولاً
```bash
npm run db:analyze
```
**لمعرفة:**
- حجم كل جدول
- عدد السجلات القابلة للحذف
- أكبر مستهلكي المساحة

### 3. 🧹 التنظيف العادي
```bash
npm run db:cleanup
```
**تنظيف متوازن:**
- حذف tracking logs أقدم من شهر
- حذف الإشعارات المقروءة أقدم من أسبوعين
- الحفاظ على البيانات المهمة

### 4. 🔄 التنظيف التلقائي
```bash
node scripts/auto-cleanup.js
```
**للاستخدام اليومي:**
- حذف tracking logs أقدم من 3 أيام
- حذف الإشعارات المقروءة أقدم من يوم

## 📋 خطة العمل المقترحة

### الخطوة 1: التنظيف الطارئ
```bash
npm run db:emergency-cleanup
```

### الخطوة 2: التحقق من النتيجة
```bash
npm run db:analyze
```

### الخطوة 3: إعداد تنظيف دوري
إضافة cron job للتنظيف اليومي:
```bash
# إضافة للـ crontab
0 2 * * * cd /path/to/project && npm run db:emergency-cleanup
```

## 🎯 البيانات الأكثر استهلاكاً للمساحة

### 1. Tracking Logs (الأكبر)
- **المشكلة:** تسجيل GPS كل ثانية للسائقين
- **الحل:** الاحتفاظ بآخر 3 أيام فقط
- **التوفير:** 80-90% من المساحة

### 2. الإشعارات
- **المشكلة:** تراكم الإشعارات المقروءة
- **الحل:** حذف المقروءة أقدم من يوم
- **التوفير:** 10-20% من المساحة

### 3. الجلسات والرموز
- **المشكلة:** عدم تنظيف البيانات المنتهية
- **الحل:** حذف المنتهية الصلاحية
- **التوفير:** 5-10% من المساحة

## ⚙️ إعدادات التحسين

### تقليل تكرار التتبع
في `/src/app/[locale]/driver/live-tracking/page.tsx`:
```javascript
// تغيير من كل ثانية إلى كل 30 ثانية
const TRACKING_INTERVAL = 30000 // بدلاً من 1000
```

### تقليل دقة الإحداثيات
```javascript
// تقليل عدد الخانات العشرية
const lat = position.coords.latitude.toFixed(6)
const lng = position.coords.longitude.toFixed(6)
```

## 🔧 حلول برمجية إضافية

### 1. ضغط البيانات
```sql
-- تحويل النصوص الطويلة لـ TEXT بدلاً من VARCHAR
ALTER TABLE tracking_logs MODIFY COLUMN notes TEXT;
```

### 2. أرشفة البيانات
إنشاء جداول أرشيف للبيانات القديمة:
```javascript
// نقل البيانات القديمة لجدول منفصل
await prisma.trackingLogArchive.createMany({
  data: oldTrackingLogs
})
```

### 3. تنظيف الملفات المرفوعة
```bash
# حذف الملفات غير المستخدمة
find uploads/ -type f -mtime +30 -delete
```

## 📈 مراقبة الاستخدام

### سكريبت مراقبة يومي
```javascript
// إضافة تنبيه عند وصول 80%
if (usagePercentage > 80) {
  console.warn('⚠️ قاعدة البيانات تقترب من الامتلاء!')
}
```

## 🎯 النصائح للمستقبل

1. **تنظيف دوري:** شغل التنظيف كل يوم
2. **مراقبة الحجم:** تحقق من الحجم أسبوعياً
3. **تحسين الكود:** قلل تكرار التتبع
4. **أرشفة البيانات:** انقل البيانات القديمة
5. **ضغط الملفات:** استخدم ضغط للملفات الكبيرة

## 🚀 للإنتاج النهائي

### سكريبت التحسين الشامل
```bash
npm run optimize:production
```
**يقوم بـ:**
- تنظيف قاعدة البيانات (tracking logs + إشعارات)
- تحسين الفهارس
- إعطاء نصائح للإنتاج
- عرض إعدادات الإنتاج المقترحة

### عند النشر على سيرفر حقيقي:
- استخدم قاعدة بيانات أكبر (PostgreSQL)
- فعل التنظيف التلقائي (cron job يومي)
- راقب الاستخدام باستمرار
- استخدم CDN للملفات الثقيلة (Cloudinary)
- فعل ضغط البيانات والـ caching

### إعدادات الإنتاج:
```env
DATABASE_URL=postgresql://user:pass@host:5432/profleet_prod
NEXTAUTH_SECRET=your-super-secret-key
CLOUDINARY_URL=cloudinary://key:secret@cloud
NODE_ENV=production
```

### Cron Job للتنظيف اليومي:
```bash
# إضافة للـ crontab
0 2 * * * cd /path/to/project && npm run db:emergency-cleanup
0 3 * * * cd /path/to/project && npm run files:cleanup
```

---

**ملاحظة:** هذه الحلول ستوفر مساحة كافية لاستكمال التطوير حتى الإنتاج النهائي بدون الحاجة للـ upgrade الآن.
